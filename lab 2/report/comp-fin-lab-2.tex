\documentclass[11pt, fleqn]{article}

\usepackage[letterpaper, margin=0.7in]{geometry}
\usepackage{graphicx}
\usepackage{subcaption}
\usepackage{cleveref}
\usepackage{listings}
\usepackage{multicol}
\usepackage{tikz}
\usepackage{bm}
\usepackage{minted}
\usetikzlibrary{arrows}
\usepackage{wrapfig}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage[section]{placeins}
\usepackage{pgfplots,wrapfig}  
\pgfplotsset{compat=newest} 
\pgfplotsset{plot coordinates/math parser=false} 
\newlength\figureheight 
\newlength\figurewidth 
\setlength{\parindent}{0pt}
\newcommand\tab[1][1cm]{\hspace*{#1}}
\usepackage{algorithm}
\usepackage[noend]{algpseudocode}

\let\oldReturn\Return
\renewcommand{\Return}{\State\oldReturn}

\raggedbottom

\begin{document}

\begin{center}

\Large{COMP6212 Assignment 2 : Shakib-Bin Hamid 25250094 sh3g12}

\end{center}

\section{Black-Scholes Equation Check Solution Correctness}

\subsection{}
Cumulative normal distribution function, $\mathcal{N}(x) = \frac{1}{\sqrt{2\pi}} \int_x^{-\infty} exp(\frac{-y^2}{2})dy$. $\mathcal{N}'(x) = \frac{1}{\sqrt{2\pi}}exp(\frac{-x^2}{2})$.

\subsection{}
\vspace{-1cm}
\begin{eqnarray*}
&& d_2 = d_1 - \sigma\sqrt{T-t}\\
&\implies& \frac{d_2^2}{2} = \frac{d_1^2}{2} + \frac{\sigma^2(T-t)}{2} - d_1\sigma\sqrt{T-t}\\
&\implies& \frac{d_1^2}{2} - \frac{d_2^2}{2} = d_1\sigma\sqrt{T-t} - \frac{\sigma^2(T-t)}{2} = log(\frac{S}{K}) + r(T-t)\\
&\implies& log(\frac{S}{K}) = \frac{d_1^2}{2} - \frac{d_2^2}{2} - r(T-t)\\
&\implies& \frac{S}{K} = exp(\frac{d_1^2}{2} - \frac{d_2^2}{2} - r(T-t)) = \frac{exp(\frac{-d_2^2}{2})}{exp(\frac{-d_1^2}{2} - r(T-t))} = \frac{\mathcal{N}'(d_2)}{\mathcal{N}'(d_1)exp(r(T-t))}\\
&\implies& S\mathcal{N}'(d_1) = Kexp(-r(T-t))\mathcal{N}'(d_2) 
\end{eqnarray*}

\subsection{}
\vspace{-1cm}
\begin{eqnarray*}
&& d_1 = \frac{log(\frac{S}{K})+(r+\frac{\sigma^2}{2})(T-t)}{\sigma\sqrt{(T-t)}} \\
&\implies& \frac{\partial d_1}{\partial S} = \frac{1}{\sigma\sqrt{(T-t)}} \frac{\partial}{\partial S}(logS - logK + (r+\frac{\sigma^2}{2})(T-t)) = \frac{1}{\sigma S \sqrt{(T-t)}}\\
&Similarly& d_2 = d_1 - \sigma\sqrt{T-t} \implies \frac{\partial d_2}{\partial S} = \frac{\partial d_1}{\partial S}= \frac{1}{\sigma S \sqrt{(T-t)}}
\end{eqnarray*}

\subsection{}
$c = S\mathcal{N}(d_1) - Kexp(-r(T-t))\mathcal{N}(d_2)$

\begin{eqnarray*}
\frac{\partial c}{\partial t} &=& \frac{\partial}{\partial t}[S\mathcal{N}(d_1) - Kexp(-r(T-t))\mathcal{N}(d_2)] \\
&=& S\mathcal{N}'(d_1)\frac{\partial d_1}{\partial t} - Kexp(-r(T-t))[r\mathcal{N}(d_2) + \mathcal{N}'(d_2)\frac{\partial d_2}{\partial t}]\\
&=& S\mathcal{N}'(d_1)\frac{\partial d_1}{\partial t} - Kexp(-r(T-t))[r\mathcal{N}(d_2) + \mathcal{N}'(d_2)(\frac{\partial d_1}{\partial t} + \frac{\sigma}{2\sqrt{T-t}})]\\
&=& [S\mathcal{N}'(d_1) - Kexp(-r(T-t))\mathcal{N}'(d_2)]\frac{\partial d_1}{\partial t} - Kexp(-r(T-t))[r\mathcal{N}(d_2) + \frac{\sigma}{2\sqrt{T-t}}\mathcal{N}'(d_2)]\\
&=& -rKexp(-r(T-t))\mathcal{N}(d_2) - \frac{\sigma}{2\sqrt{T-t}}S\mathcal{N}'(d_1)
\end{eqnarray*}

\begin{eqnarray*}
\frac{\partial c}{\partial S} = \mathcal{N}(d_1) + \frac{1}{\sigma S \sqrt{(T-t)}}[S\mathcal{N}'(d_1) - Kexp(-r(T-t))\mathcal{N}'(d_2)] = \mathcal{N}(d_1)
\end{eqnarray*}

\subsection{}
$
\frac{\partial c}{\partial S} = \mathcal{N}(d_1)
\implies \frac{\partial^2 c}{\partial S^2} = \mathcal{N}'(d_1)\frac{\partial d_1}{\partial S} = \mathcal{N}'(d_1)\frac{1}{\sigma S \sqrt{(T-t)}}
$

\vspace{-0.5cm}

\begin{eqnarray*}
\frac{\partial c}{\partial t} &=& -rKexp(-r(T-t))\mathcal{N}(d_2) - \frac{\sigma}{2\sqrt{T-t}}S\mathcal{N}'(d_1) \\
\frac{\sigma^2S^2}{2}\frac{\partial^2 c}{\partial S^2} &=& \mathcal{N}'(d_1)\frac{1}{\sigma S \sqrt{T-t}}\times\frac{\sigma^2S^2}{2} = \frac{\sigma}{2\sqrt{T-t}}S\mathcal{N}'(d_1)\\
rS\frac{\partial c}{\partial S} &=& \mathcal{N}(d_1)rS\\
-rc &=& -r(S\mathcal{N}(d_1) - Kexp(-r(T-t))\mathcal{N}(d_2)) = -rS\mathcal{N}(d_1) + rKexp(-r(T-t))\mathcal{N}(d_2)
\end{eqnarray*}

Adding the above - $\frac{\partial c}{\partial t} + \frac{\sigma^2S^2}{2}\frac{\partial^2 c}{\partial S^2} + rS\frac{\partial c}{\partial S} - rc = 0$. So, Black-Scholes PDE is correct for European call option.

\section{Black-Scholes Option Price vs Actual Option Price}

Black-Scholes equation has a closed form solution, $c = S\mathcal{N}(d_1) - Kexp(-r(T-t))\mathcal{N}(d_2)$, given that the volatility, i.e. Standard Deviation of log returns, $u_i = log(a_i)$ is constant for an asset \cite{hull}. In this formula, interest rate $r$, time to maturity, $T$, current stock price of the underlying asset, $S$ are constants of the domain. Only, volatility, $\sigma$ needs to be derived from past data. As long as the volatility does not change over time until maturity, the option price will be fair \footnote{the x axis in the figures show $10^4$ because of a bug in the \texttt{tikz} package for numeric dates}.

\begin{figure}[!h]
\begin{center}
	\resizebox {0.6\textwidth} {!} {\input{q2-prices.tex} }
	\caption{Black-Scholes vs Actual Option Prices}
	\label{fig:q2-prices}
	\vspace{-0.8cm}
\end{center}
\end{figure}

\vspace{-0.3cm}

\begin{algorithm}[H]
\caption{Calculating Black-Scholes Option Price}
\label{alg:black-sholes}
\begin{algorithmic}
\State $r = 0.06$ // interest rate
\For {$i \in \{1,...,3T/4\}$} // T = total days = 222
\State $idx = T/4 + i$ // current day
\State $S = stocks(idx)$ // today's stock price
\For {$j \in \{1,...,N\}$} // N = number of options = 10
\State $K = strikePrices(j)$ // strike price of the option
\State $\tau = (dates(T)+1 - dates(idx))/365$ // maturity time in years
\State $\sigma = std(log(returns(i:T/4+i-1, j)))$ // volatility as SD of log returns
\State $[p, c] = blsprice(S, K, r, \tau, \sigma)$ // matlab function for Black-Scholes price
\If {$isCallOption(j)$}
\State $estPrices(i,j) = c$
\Else
\State $estPrices(i,j) = p$
\EndIf
\EndFor
\EndFor
\end{algorithmic}
\end{algorithm}

Algorithm \ref{alg:black-sholes} describes how I calculated the option prices for the 10 options from $T/4 + 1$ to $T$ days. Then I plotted the estimated option prices against the actual traded prices in Figure \ref{fig:q2-prices}.

\begin{figure}[!h]
   \centering 
   \begin{subfigure}[b]{0.45\textwidth}
     	\resizebox {\textwidth} {!} {\input{q2-error.tex} }
		\label{fig:q2-error}
    \end{subfigure}
    ~
    \begin{subfigure}[b]{0.45\textwidth}
       	\resizebox {\textwidth} {!} {\input{q2-error-boxplot.tex} }
        \label{fig:q2-error-boxplot}
    \end{subfigure}
	\vspace{-0.5cm}
    \caption{Absolute Error between Black-Scholes and Actual Option Prices}
	\label{fig:q2-error-both}
\end{figure}

\begin{wrapfigure}{!h}{0.45\textwidth}
\vspace{-1.5cm}
\begin{center}
	\resizebox {0.4\textwidth} {!} {\input{q2-bls-parameters.tex} }
	\caption{Black-Scholes Parameters}
	\label{fig:q2-bls-parameters}
	\vspace{-1cm}
\end{center}
\end{wrapfigure}

Then I calculated the absolute error between the Black-Scholes option price and the actual traded price. They were plotted in Figure \ref{fig:q2-error-both}. Finally, using Matlab's Financial Toolbox, I calculated the greeks for each option over that period and plotted them in Figure \ref{fig:q2-bls-parameters}.\\

As can be seen from Figure \ref{fig:q2-prices}, the call option prices closely followed the Black-Scholes solution. One exception here is a spike which can also be seen in Figure \ref{fig:q2-error-both} as well where the absolute error was quite substantial compared to other call options.\\

On the other hand, there was a systematic difference between the Black-Scholes formula and actual prices for the put options, seen in both Figure \ref{fig:q2-prices} and \ref{fig:q2-error-both}. All put options were traded at a higher price than that derived from Black-Scholes formula. Thus the absolute errors were also quite large and dispersed.\\

In Figure \ref{fig:q2-bls-parameters}, one of the volatilities has a spike near the end. This is precisely the call option whose price spiked at the same time. This leads me to believe that the price is correlated to the volatility of the underlying asset. Vega, $\nu=\frac{\partial c}{\partial \sigma}$ demonstrates exactly this. Clearly, as time to maturity draws near, the effect steadily goes down to 0. Delta $\Delta=\frac{\partial c}{\partial S}$ is also depicted in the same Figure over the same time period. Note that the horizontal scale is the time from the beginning of observation to the maturity date.

\section{Implied Volatility}

In implementing Black-Scholes solution, I calculated the volatility from the previous $T/4$ day's historical data. However, actual traders will use other factors, such as their experience or recent market movements etc. to negotiate or write the prices for their options. So, the prices observed for the options will almost always be different from those derived from the Black-Scholes equation, as seen in the previous section. However, this gives a chance to calculate what the traders or market believe the volatility should be by working backwards. This is called the implied volatility.

\begin{figure}[!h]
   \centering 
   \begin{subfigure}[b]{0.45\textwidth}
     	\resizebox {\textwidth} {!} {\input{q3-historical-vs-implied-volatility.tex} }
		\caption{Historical vs Implied Volatility Scatter Plot}
		\label{fig:q3-historical-vs-implied-volatility}
    \end{subfigure}
    ~
    \begin{subfigure}[b]{0.44\textwidth}
       	\resizebox {\textwidth} {!} {\input{q3-volatility-days.tex} }
		\caption{Historical and Implied Volatility over Time}
        \label{fig:q3-volatility-days}
    \end{subfigure}
    \caption{Volatility vs Implied Volatility}
	\label{fig:vol-vs-impl-vol}
\end{figure}

I started by randomly selecting $T/5$ days between day $T/4+1$ and $T$ and sorting them so that they fall in chronological order. Then I used Matlab's Financial Toolbox to calculate the implied volatility for those days. In some cases, it could not be computed and returned \texttt{NaN}. Getting rid of such days' data, I was left with $\approx 30$ days' worth of implied volatility. I then also calculated the historical volatility of those days from previous $T/4$ days' data. Finally, I plotted a scatter diagram in Figure \ref{fig:q3-historical-vs-implied-volatility}. Since the selected data was sorted chronologicaly, I also plotted both the implied and historical volatility over time in Figure \ref{fig:q3-volatility-days}.\\

An assumption of the Black-Scholes formula is that volatility of an asset is constant on any day, leading up to the maturity day. As, we have seen this is not the case. What is of interest then is how it changes depending on the strike price. A graph of implied volatility vs strike price on a day will have a valley or 'smile' shape, giving the name 'Volatility Smile'. I picked 10 random days and for each day calculated the implied volatility on that day for each of the 5 strike prices. Then I plotted the volatility smile in Figure \ref{fig:q3-volatility-smile}.

\begin{figure}[!h]
   \centering 
   	\resizebox {0.6\textwidth} {!} {\input{q3-volatility-smile.tex} }
    \caption{Volatility Smile}
	\label{fig:q3-volatility-smile}
\end{figure}

As seen from Figure \ref{fig:q3-historical-vs-implied-volatility}, there is a systematic difference between the historical and implied volatilities for the put options. The implied volatility was almost always higher than the historical volatility. This suggests that the market had some prior knowledge about the options. From the previous section, it can be seen that these put options' actual price was also always higher than the ones produced by the Black-Scholes formula. It indicates that the market was paying higher price for options whose underlying assets' implied volatilities were higher. As for the call options, we see that the implied volatilites are more in line with the historical volatility, except for one spike which was also observed in the pricing difference.\\

In Figure \ref{fig:q3-volatility-smile} we can see that the put options, on most days, have the regular volatility smile, i.e. market deemed assets least volatile around the mean of the strike price range. Then the volatility was larger around the mean, giving the smile shape. However, for one day of the put option and most days of the call options, the smile was more of a logarithmic shape. In case of the call options, on most days implied volatility seems to have increased as the strike price increased until they plateaued. I suspect it is because the market thinks that the underlying option has some intrisic value if the strike price is going up, so the implied volatility is increasing with it. We need to investigate the market in 1994 for call options on FTSE 100 index to find out more.

\section{Option Pricing using Binomial Lattice over Discrete Intervals}

Black-Scholes equation is derived under some very strict conditions, including assuming that the stock prices follow a geometric brownian motion and volatility is constant for that stock over time. This leads to a closed form solution of the equation, the option price. On the other hand, if we model stock price such that it can go up to $S_t = uS_{t-\delta t}$ or down to $S_t = dS_{t-\delta t}$ with a probability of $p$, and construct a binomial lattice until time $T$, we get a distribution of resultant stock prices with corresponding probabilities of achieving those stock prices. From this distribution, we can work backwards and arrive at a fair price for an option over the underlying asset today. What we are interested in is how the price derived from a discrete interval method differ from the restricted, but closed form solution of a continuous model. If they are similar, we can use the lattice to relax some of the constraints and price more interesting options, e.g. American style options.

\begin{figure}[!h]
   \centering 
   \begin{subfigure}[b]{0.45\textwidth}
     	\resizebox {\textwidth} {!} {\input{q4-bls-vs-binomial.tex} }
		\caption{Pricing Difference between Binomial Lattice and Black-Scholes vs $\delta t$}
		\label{fig:q4-bls-vs-binomial}
    \end{subfigure}
    ~
    \begin{subfigure}[b]{0.44\textwidth}
       	\resizebox {\textwidth} {!} {\input{q4-bls-vs-binomial-vs-monte-error.tex} }
		\caption{Pricing Difference for Various Methods}
        \label{fig:q4-bls-vs-binomial-vs-monte-error}
    \end{subfigure}
    \caption{Option Pricing Difference}
	\label{fig:pricing-difference}
\end{figure}

I began by selecting a random strike price and a random start date after $T/4$ for a random call option. Then I calculated the option price using the Black-Scholes formula. Then I used the Financial Toolbox function, \texttt{binprice}, to run the binomial lattice over the period. From it I retrieved the price on the same day as the Black-Scholes' price. This method was done for $\delta t = $\texttt{logspace(1,4,20)}. I then plotted the absolute difference between the two pricing methods for different values of $\delta t$ in Figure \ref{fig:q4-bls-vs-binomial}. As expecated the difference gets smaller as $\delta t$ decreases. It is interesting that it is an exponential decrease. Note that, lowering $\delta t$ will also make the lattice extremely large and memory starts becoming an issue at this point.\\

At the same time, I wanted to compare the two methods with a monte carlo simulation (see Algorithm \ref{alg:mcarlo}) for put options. I calculated the errors (difference between the method predicted price and actual traded price) over $T/2$ random days after $T/4$th day for each of the methods and made a box plot in Figure \ref{fig:q4-bls-vs-binomial-vs-monte-error}. $\delta t$ was 1 day in this case. As expected the monte carlo method produced nearly the same results as the Black-Scholes formula. But the binomial lattice actually performed better in almost all runs of the program. This makes it a very interesting, flexible and competitive method for option pricing.

\begin{algorithm}[H]
\caption{Calculating Monte Carlo Option Price}
\label{alg:mcarlo}
\begin{algorithmic}
\Function{monteCarlo}{$S, K, r, \tau, \sigma$}
\State $M = 10^4$ // number of trials
\State $vals=S\times exp(\tau(r-\sigma^2/2) + \sigma\sqrt{\tau}randn(M,1))$ // value on maturity day
\State $optVals=max(S-vals,0)$ // evaluate the put options
\State $presentVals=e^{-r\tau}\times optVals$ // discount to present day
\State $interval=1.96\times std(presentVals)/\sqrt{M}$ // confidence intervals
\State $putVal=mean(presentVals)$
\State $putRange = [putVal-interval, putVal+interval]$
\Return $[putVal,putRange]$
\EndFunction
\end{algorithmic}
\end{algorithm}

\section{Pricing an American Put Option using Binomial Lattice}

Figure 7.10 in \cite{brandimarte} describes an algorithm to calculate american put option price using a binomial lattice. The procedure here is similar to that of an European put option. However, one key difference is that in case of an american option, a trader can exercise the option at any point until the maturity date. So, when working backwards, we have to consider wheter to exercise the option, or to hold further.\\

The snippet in the assignment is working backwards from the maturity day. For each cell in the lattice, it is calculating the payoff if the option is exercised on that day \texttt{K - SVals(i)} and the payoff if it is held further \texttt{hold}. Like dynamic programming, we make a decision here and clearly whichever strategy is better at the cell, is chosen, i.e. \texttt{max} of the two values. So, in short, the snippet is about working backwards in the binomial lattice and choosing between selling off the asset or holding the option based on the payoff for each action.\\

In case of a call option, the same will be done. Except that this time the payoff for exercising the option will be \texttt{SVals(i) - K}, since we are in the money if \texttt{SVals(i)>K}.


\begin{thebibliography}{9}
\bibitem{hull} 
J. C. Hull
\textit{Options, Futures and Other Derivatives}. 
Prentice Hall, 2009

\bibitem{brandimarte} 
P. Brandimarte
\textit{Numerical Methods in Finance and Economics.}. 
Wiley, 2006

\end{thebibliography}

\end{document}











