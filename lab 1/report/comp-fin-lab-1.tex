\documentclass[11pt]{article}

\usepackage[letterpaper, margin=0.7in]{geometry}
\usepackage{graphicx}
\usepackage{subcaption}
\usepackage{cleveref}
\usepackage{listings}
\usepackage{multicol}
\usepackage{tikz}
\usepackage{bm}
\usepackage{minted}
\usetikzlibrary{arrows}
\usepackage{wrapfig}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage[section]{placeins}
\usepackage{pgfplots,wrapfig}  
\pgfplotsset{compat=newest} 
\pgfplotsset{plot coordinates/math parser=false} 
\newlength\figureheight 
\newlength\figurewidth 
\setlength{\parindent}{0pt}
\newcommand\tab[1][1cm]{\hspace*{#1}}
\usepackage{algorithm}
\usepackage[noend]{algpseudocode}
\raggedbottom

\begin{document}

\begin{center}

\Large{COMP6212 Assignment 1 : Shakib-Bin Hamid 25250094 sh3g12}

\end{center}

\section{Efficient Frontier}

Let a portfolio of $N$ assets be $\bm{\pi}$, whose expected return is $\bm{\mu}$ and the 
co-variance is $\bm{\Sigma}$. \\

\subsection{Efficient Frontier with 3 Assets}

\begin{wrapfigure}{!h}{0.45\textwidth}
	\vspace{-2cm}
  \begin{center}
    \resizebox {0.4\textwidth} {!} {\input{q1_a_efficient_frontier.tex} }
	\caption{Efficient Portfolio}
	\label{fig:q1-a-efficient-portfolio}
  \end{center}
	\vspace{-1cm}
\end{wrapfigure}

According to the paper, the expected return of the portfolio, 
$E = \sum_{i=1}^N\pi_i\mu_i = \bm{\pi}^t\bm{\mu}$. The risk is analogous to the variance of
the returns, i.e. $V = \sum_{i=1}^N\sum_{j=1}^N\sigma_{ij}\pi_i\pi_j = \bm{\pi}^t\bm{\Sigma}\bm{\pi}$.\\

Given $\bm{\mu} = \bm{m}$ and $\bm{\Sigma} = \bm{C}$ for a $3$ assets, we can generate 100 random
portfolios, where each portfolio $\bm{\pi} = (\pi_1, \pi_2, \pi_3)^t$ s.t. $\bm{1}^t\bm{\pi} = 1$ by
\mintinline{matlab}|y=randn(3,1); y=y/norm(y,1)|. Then we can calculate $E-V$ for each of the portfolios by
\mintinline{matlab}|E=y'*m; V=sqrt(y'*C*y)|.\\

Finally I make the scatter plot and on the same figure I plot the efficient frontier using
\mintinline{matlab}|estimateFrontier| function. As expected all the random portfolios were on the
correct one side of the frontier. 

\subsection{Efficient Frontier with 2 Assets}

To prepare three 2 asset porfolios, I removed the data points that are not necessary, i.e. that has
the third asset. First I plotted random returns generated by the 2 asset mean and variance using
\mintinline{matlab}|mvnrnd|. As can be noticed from Figure \ref{fig:q1-b-return-distribution}, asset
2 and 3 are almost uncorrelated, asset 1 and 2 are negatively correlated, asset 1 and 3 are positively
correlated.\\

\begin{figure}[!h]
	\vspace{-0.5cm}
	\centering 
	\resizebox {0.7\textwidth} {!} {\input{q1_b_return_distribution.tex} }
	\caption{Distribution of 2 Asset Returns}
	\label{fig:q1-b-return-distribution}
	\vspace{-0.5cm}
\end{figure}

As done previously with all three assets, I generate 100 random portfolios for each of the three 2 asset
combinations and plot the $E-V$ scatters along with the efficient frontiers. Notice that in case of 2 asset portfolios, every portfolio construction is efficient and the frontier
has a bend, i.e. risk increases for the lowest returns. The reason for all portfolios lying on the efficient porfolio
is as follows - \\

Represent porfolio for two assets as $\bm{\pi} = (\pi, 1-\pi), \bm{\mu} = (\mu_1, \mu_2), \bm{\Sigma}=(\sigma_1, \sigma; \sigma, \sigma_2)$.
Then $E = \pi\mu_1 + (1-\pi)\mu_2, V = \pi^2(\sigma_1 + \sigma_2) +2\pi(\sigma - \sigma_2) + \sigma_2$. The second derivative
of both are devoid of $\pi$, because of this reduction of degree of freedom. So, the $E-V$ will always be the extremum
regardless of the portfolio.

\begin{figure}[!h]
   \centering 
   \begin{subfigure}[b]{0.23\textwidth}
     	\resizebox {\textwidth} {!} {\input{q1_b_efficient_frontier_1.tex} }
		\label{fig:q1-b-efficient-frontier-1}
    \end{subfigure}
    ~
    \begin{subfigure}[b]{0.23\textwidth}
       	\resizebox {\textwidth} {!} {\input{q1_b_efficient_frontier_2.tex} }
        \label{fig:q1-b-efficient-frontier-2}
    \end{subfigure}
	~
    \begin{subfigure}[b]{0.23\textwidth}
       	\resizebox {\textwidth} {!} {\input{q1_b_efficient_frontier_3.tex} }
        \label{fig:q1-b-efficient-frontier-3}
    \end{subfigure}
	~
    \begin{subfigure}[b]{0.23\textwidth}
       	\resizebox {\textwidth} {!} {\input{q1_b_efficient_frontier_all.tex} }
        \label{fig:q1-b-efficient-frontier-all}
    \end{subfigure}
	\vspace{-0.5cm}
    \caption{Efficient Frontier for 2 Asset Portfolios}\label{fig:naive_v_cvx}
\end{figure}

\subsection{Use of \texttt{linprog} in NaiveMV}

In order to calculate the efficient frontier, I needed two extreme points - maximum return for a 
portfolio regardless of the risk and minimum risk regardless of the return. For the first case,
$E = \underset{w}{max}(\bm{\pi}^t\bm{\mu})$ s.t. $\bm{1}^t\bm{\pi} = 1$ which gives the portfolio that 
maximises the return regardless of the risk. We can then calculate $E-V$ for this portfolio, thus giving
us the top corner of the $E-V$ graphs here. This is a linear equation of $\bm{\pi}$. Matlab's
\mintinline{matlab}|linprog| function can solve linear equation of the following form -

\begin{minipage}{.4\textwidth}
  	\[
		\underset{x}{min}(f^tx) s.t. 
	\begin{cases}
		A.x \leq b\\
		A_{eq}.x = b_{eq}\\
		lb \leq x \leq ub
	\end{cases}
	\]
\end{minipage}% This must go next to `\end{minipage}`
\begin{minipage}{.6\textwidth}
  	\mintinline{matlab}|f=-ERet;A=[];b=[];Aeq=ones(1,N);beq=1;lb=0;ub=1|
\end{minipage}

However, to calculate the portfolio that minimises the risk we need to solve a quadratic equation of 
$\bm{\pi}$, $\underset{w}{min}(\bm{\pi}^t\bm{\Sigma}\bm{\pi})$ s.t. $\bm{1}^t\bm{\pi} = 1$. In this case we use the
\mintinline{matlab}|quadprog| function. Finally, we choose $N$ expected portfolio returns between the two extreme
points and calculate the porfolio that minimises the risk while achieving the chosen expected returns.
Thus the efficient portfolio is created.

\subsection{Efficient Frontier : NaiveMV vs CVX}

Using the CVX tool we can declarively perform the convex optimisations we performed earlier with
\mintinline{matlab}|linprog| and \mintinline{matlab}|quadprog|, as follows -

\vspace{0.5cm}

\begin{minipage}{.4\textwidth}
  	\begin{minted}{matlab}
	cvx_begin quiet
		variable w(N,1)
		minimize( -ERet'*w )
		subject to
			ones(1,N)*w == 1;
			w >= zeros(N,1);
	cvx_end
	\end{minted}
\end{minipage}% This must go next to `\end{minipage}`
\begin{minipage}{.6\textwidth}
  	\begin{minted}{matlab}
	cvx_begin quiet
		variable w(N,1)
		minimize( 0.5*w'*ECov*w + zeros(N,1)'*w)
		subject to
			ones(1,N) * x == 1;
			x >= zeros(N,1);
	cvx_end
	\end{minted}
\end{minipage}

\begin{figure}[!h]
    \centering 
   \begin{subfigure}[b]{0.30\textwidth}
     	\resizebox {\textwidth} {!} {\input{q1_d_naive_v_cvx.tex} }
     \caption{Similarity}
    \label{fig:q1-d-naive-v-cvx}
    \end{subfigure}
    ~
    \begin{subfigure}[b]{0.30\textwidth}
       	\includegraphics[scale=.5] {q1_d_naive_v_cvx_difference.eps}
       \caption{Difference}
        \label{fig:q1-d-naive-v-cvx-difference}
    \end{subfigure}
    \caption{NaiveMV vs Using CVX}\label{fig:naive_v_cvx}
\end{figure}

The results are extremely similar, since differences only show up in $10^{-7}$ scale. However, the
CVX tool was noticeably slower.

\section{Markowitz vs Naive $1/N$ Strategy on FTSE 100}

\subsection{Getting FTSE 100 Data}

I downloaded the FTSE 100 index and the top 30 most traded companies' data over the last 3 years using
a \texttt{bash} script. Then I used a \texttt{ruby} script to fill in the missing days (which may be
weekends) with the previous day's data. As a result all data had the same number of rows. The returns 
will be calculated based on the adjusted close values. Figure \ref{fig:q2_return} plots the data.

\begin{figure}[!h]
   \centering 
   \begin{subfigure}[b]{0.23\textwidth}
     	\resizebox {\textwidth} {!} {\input{q2_ftse.tex} }
		\label{fig:q2-ftse}
    \end{subfigure}
    ~
    \begin{subfigure}[b]{0.23\textwidth}
       	\resizebox {\textwidth} {!} {\input{q2_returns.tex} }
        \label{fig:q2_returns}
    \end{subfigure}
	~
    \begin{subfigure}[b]{0.23\textwidth}
       	\resizebox {\textwidth} {!} {\input{q2_random_assets_return.tex} }
        \label{fig:q2_random_assets_return}
    \end{subfigure}	
	\vspace{-0.5cm}	
    \caption{FTSE 100, Top 30 Most Traded Company and Selected 3 Company Adjusted Close over 3 Years}\label{fig:naive_v_cvx}
	\label{fig:q2_return}	
	\vspace{-0.5cm}
\end{figure}

\subsection{Returns and Efficient Portfolio of 3 Random Assets}

I started by calculating the returns as percentage. I defined the return in two ways - 

\begin{itemize}
	\item $return(i+1) = (val(i+1) - \mathit{val(i)})/val(i+1)$, return based on daily investment
	\item $return(i+1) = (val(i+1) - \mathit{val(1)})/val(i+1)$, return based on first investment
\end{itemize}

I expected portfolio returns in first definition to be jittery in a small window since daily returns
go up and down. Whereas the second definition would be smoother, although it implicitly imposes a correlation. 
Figure \ref{fig:q2-all-assets-all-based-on-daily} and \ref{fig:q2-all-assets-all-based-on-first} build a portfolio out of \textbf{all} 30 assets, whereas
Figure \ref{fig:q2-all-based-on-daily} and \ref{fig:q2-all-based-on-first} select \textbf{3} random assets,
which were controlled using \mintinline{matlab}|rng(1)|. The resultant assets were AAL, KGF and RDSB.
Their adjusted closing values were plotted in Figure \ref{fig:q2_return}.

\begin{figure}[!h]
   \centering 
 	\resizebox {\textwidth} {!} {\input{q2_all_assets_all_based_on_daily.tex} }
    \caption{Portfolio of \textbf{all} 30 assets analysis where returns are based on \textbf{daily} change}
	\label{fig:q2-all-assets-all-based-on-daily}
	\vspace{-0.3cm}
\end{figure}

As expected, the portfolio returns over time were moving between $\pm0.02$ if we calculated returns
based on daily investment. It was smoother when returns were calculated based on the first investment. The efficient frontier in
both cases were of expected shape.

\begin{figure}[!h]
   \centering 
 	\resizebox {\textwidth} {!} {\input{q2_all_based_on_daily.tex} }
    \caption{Portfolio of \textbf{3 random} assets analysis where returns are based on \textbf{daily} change}
	\label{fig:q2-all-based-on-daily}
	\vspace{-0.3cm}
\end{figure}

\begin{figure}[!h]
   \centering 
 	\resizebox {\textwidth} {!} {\input{q2_all_assets_all_based_on_first.tex} }
    \caption{Portfolio of \textbf{all} 30 assets analysis where returns are based on \textbf{first return}}
	\label{fig:q2-all-assets-all-based-on-first}
	\vspace{-0.3cm}
\end{figure}

\begin{figure}[!h]
   \centering 
 	\resizebox {\textwidth} {!} {\input{q2_all_based_on_first.tex} }
    \caption{Portfolio of \textbf{3 random} assets analysis where returns are based on \textbf{first return}}
	\label{fig:q2-all-based-on-first}
	\vspace{-0.5cm}
\end{figure}

\subsection{Comparison with Naive Strategy}

After chronologically sorting the data, I picked the first half of the data as the training set and the
rest as the validation set. Using the first half, I calculated the Expected Return as the mean and the
Risk as the covariance using \mintinline{matlab}|m = mean(returnsTrain);C = cov(returnsTrain);|. Then
Financial Toolbox calculated the efficient frontier. Then I picked $V_{max}/2$ to be max risk 
and calculated the weights, which I picked as the Markowitz portfolio for comparison. 
\mintinline{matlab}|1/N*ones(N,1)| was the naive 1/N strategy portfolio.\\

I started the comparison by calculating the returns over the validation set. I used the Markowitz
portfolio selected from the training data and the 1/N portfolio stated above -

\begin{minted}{matlab}
effReturn = returnsTest * efficientWeights';
naiveReturn = returnsTest * naiveWeights';
\end{minted}

I plotted them in the second subfigures in the figures in this section. In this particular
selection of assets, the markowitz portfolio beat the naive one. However, it was not the case every time.
On some runs of the experiment, the naive strategy was giving better returns on the graph.\\

Then I calculated the sharpe ratio, defined as $r = (m - r_0)/\sigma$, where $r_0$ is the risk free return.
I set \mintinline{matlab}|riskFree = 0.05| and calculated the following -

\begin{minted}{matlab}
naiveSharpe = (mean(naiveReturn) - riskFree)/std(naiveReturn);
effSharpe = (mean(effReturn) - riskFree)/std(effReturn);
\end{minted}

The sharpe ratio is plotted in the 4th subfigures in the figures in this section. Surprisingly the sharpe
ratios in both cases were often negative, meaning that risk free assets, if it returned 5\%, would be better.
The reason for this is that the assets actually performed poorly in adjusted close values during this
time, as seen in Figure \ref{fig:q2_return}. Unsurprisingly, if we set $r_0 = 0$, i.e. no returns are risk free,
then the sharpe ratios are positive. Also, a larger sharpe ratio can suggest a better performing portfolio. So, whichever portfolio showed
better returns on the 2nd subfigures had the larger sharpe ratio on the 4th subfigures. I think the sharpe ratio
is a reasonable measure of performance, but it depends largely on the estimate of the risk free assets like -
government bonds etc.

\section{Index Tracking}

Since the index is improving over the years, a passive investor will likely want to invest in the index as a whole.
However, investing in a large number of companies comes with the problem of tackling transaction costs. So, it is
desirable to invest in a subset of the index assets that, as combination, closely matches the performance of the index
itself. I investigated two ways of selecting one fifth of the $N$ assets that represent the index. I first selected
 =the first half of the data as training data and the rest as the validation data.

\subsection{Greedy Forward Search Asset Selection}

During each iteration of the greedy algortithm, I go through each of the unselected assets and try to find the most
effective linear combination containing it and the assets already chosen. The Root Mean Squeared Error (RMSE) is then
recorded for that asset combination. At the end of the iteration, I choose the asset combination that produced the 
least RMSE. Finally, after $N/5$ iterations, I find the overall desired subset of assets. The algorithm is described in
Algorithm \ref{alg:greedy-index}.

\begin{algorithm}[H]
\caption{Greedy Asset Selection for Index Tracking}
\label{alg:greedy-index}
\begin{algorithmic}
\State S = \{\} // the desired subset of assets
\For {$i \in \{1,...,N/5\}$} // N = number of total assets
\State $e = \{\}$ // RMSE vector
\For {$j \in \{1,...,N\}$}
\If {$j \in \{S\}$}
\State $e(j) = \infty$ // asset already chosen
\Else
\State $s = S \bigcup \{j\}$ // temporary subset containing current asset
\State $\bm{R_t} = \bm{R}(:, s)$ // training set asset return
\State $\bm{w} = \underset{\bm{w}}{min}(||\bm{w}'\bm{R_t} - \bm{y_t}||_2) s.t. \bm{1}^t\bm{w} = 1, \bm{w} \geq \bm{0}$ // $\bm{w}$ = weights, $\bm{y_t}$ = training set index return
\State $e(j) = \sqrt{mean(||\bm{r_t} * \bm{w}' - \bm{y_t}||_2^2)}$
\EndIf
\EndFor
\State $idx = minIdx(e)$ // index of the portfolio with minimum RMSE in this iteration
\State $S = S \bigcup \{idx\}$
\EndFor
\end{algorithmic}
\end{algorithm}

During the asset selection algorithm, the RMSE is calculated based on the training set, since we want to only fit the
training data. Once the assets are determined, we find the effective portfolio based on only the training data and 
apply it on the validation data to see how well it performs. As can be seen from Figure \ref{fig:q3-greedy},
the representative index closely matches the training index, and deviates more on the validation data.

\begin{figure}[!h]
	\vspace{-0.5cm}
   \centering 
 	\resizebox {0.8\textwidth} {!} {\input{q3_greedy.tex} }
    \caption{Greedy Index Tracking}
	\label{fig:q3-greedy}
	\vspace{-0.5cm}
\end{figure}

\subsection{Sparse Portfolio for Index Tracking}

We perform the greedy search so that we don't have to search the entire combinatorial space. However, any markowitz
porfolio construction can be ill conditioned, if there is significant correlation between the assets. So, I introduce
a $l_1$ regulariser term $\tau||\bm{w}||_1$ with the alternative, but equivalent optimisation problem, 
$\underset{\bm{w}}{min}(||\bm{w}'\bm{R} - \rho\bm{1}||_2)$ in order to stabilise the optimisation problem. Then the top
$N/5$ most contributing assets are chosen and the optimisation is run again to redistribute the weights over the 
chosen assets. As before, the weights are chosen to fit the training index and then applied to the validation set
to compare with the actual validation index. The results are as expected as seen in Figure \ref{fig:q3-sparse}.
It is interesting that if we do not redistribute the weights over the assets, and rather only invest a fraction of
our total wealth, it produces better performance on the validation set (Figure \ref{q3-sparse-no-distribution})!

\begin{algorithm}[H]
\caption{Sparse Asset Selection for Index Tracking}
\label{alg:sparse-index}
\begin{algorithmic}

\State $\bm{w} = \underset{\bm{w}}{min}(||\bm{w}'\bm{R_t} - \bm{y_t}||_2 + \tau||\bm{w}||_1) s.t. \bm{1}^t\bm{w} = 1, \bm{w} \geq \bm{0}$
\State $S = sortIdx(w)$
\State $S = S(1:N/5)$

\end{algorithmic}
\end{algorithm}

\begin{figure}[!h]
   \vspace{-0.5cm}
	\centering 
 	\resizebox {0.8\textwidth} {!} {\input{q3_sparse.tex} }
    \caption{Sparse Index Tracking}
	\label{fig:q3-sparse}
	\vspace{-0.5cm}
\end{figure}

\begin{figure}[!h]
	\vspace{-0.5cm}
   \centering 
 	\resizebox {0.8\textwidth} {!} {\input{q3_sparse_no_redistribution.tex} }
    \caption{Sparse Index Tracking without Redistribution after Asset Selection}
	\label{fig:q3-sparse-no-distribution}
	\vspace{-0.5cm}
\end{figure}

Whether the sparse portfolio using the regulariser is preferred over using the greedy algorithm is more a matter of art and prior 
knowledge. The idea is that a sparse portfolio is desired, but the way to achieve it can be different. Tuning $\tau$ is crucial and
here we only tune it to match the number of selections to the number chosen by the greedy algorithm so that we can compare
on the same grounds.


\end{document}



















































